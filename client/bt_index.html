<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicarX Bluetooth Controller</title>
    <link rel="stylesheet" type="text/css" href="./stacks.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 300px;
            margin: 20px auto;
        }

        .controls button {
            padding: 20px;
            font-size: 18px;
            cursor: pointer;
        }

        .button-row {
            text-align: center;
            margin: 15px 0;
        }

        #up {
            grid-column: 2;
        }

        #left {
            grid-column: 1;
            grid-row: 2;
        }

        #right {
            grid-column: 3;
            grid-row: 2;
        }

        #down {
            grid-column: 2;
            grid-row: 3;
        }

        #videoContainer {
            margin: 20px auto;
            text-align: center;
        }

        #videoFeed {
            max-width: 100%;
            margin-top: 10px;
        }

        #status {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #mapContainer {
            background: var(--theme-background-color, #fff);
            border: 1px solid var(--theme-border-color, #ccc);
            border-radius: 4px;
            padding: 15px;
            margin: 20px auto;
            max-width: 600px;
        }

        #mapVisualization {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 4px;
            max-width: 100%;
        }

        #asciiMap {
            margin-top: 15px;
            padding: 10px;
            background: var(--theme-code-background-color, #f5f5f5);
            border-radius: 4px;
            white-space: pre;
            font-family: monospace;
            overflow-x: auto;
        }

        .connection-controls {
            background: var(--theme-background-color, #fff);
            border: 1px solid var(--theme-border-color, #ccc);
            border-radius: 4px;
            padding: 15px;
            margin: 20px auto;
        }

        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .indicator.disconnected {
            background-color: #ff4d4d;
        }

        .indicator.connected {
            background-color: #4CAF50;
        }

        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
<h1>PicarX Bluetooth Controller</h1>

<div id="status">Status: Disconnected</div>

<div class="connection-controls">
    <h3>
        <span id="connectionIndicator" class="indicator disconnected"></span>
        Bluetooth Connection
    </h3>
    <div>
        <input type="text" id="macAddress" placeholder="Enter Raspberry Pi MAC address"
               value="" style="width: 250px; padding: 5px;">
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
</div>

<div class="controls">
    <button id="up" disabled>↑</button>
    <button id="left" disabled>←</button>
    <button id="right" disabled>→</button>
    <button id="down" disabled>↓</button>
</div>

<div class="button-row">
    <button id="scanEnv" disabled>Scan Environment</button>
</div>

<div class="button-row">
    <button id="toggleVideo" disabled>Start Video Feed</button>
</div>

<div id="videoContainer">
    <img id="videoFeed" style="display: none;">
</div>

<div id="mapContainer" style="margin: 20px auto; text-align: center;">
    <h2>Environment Map</h2>
    <img id="mapVisualization" style="max-width: 100%; margin-top: 10px;">
    <pre id="asciiMap" style="text-align: left;"></pre>
</div>

<div class="button-row">
    <button id="toggleDebug">Show Debug Info</button>
</div>

<div id="debugInfo" class="debug-info"></div>

<script>
    // API endpoint (local bridge server)
    const API_URL = window.location.origin;  // Use the same origin as the page
    const status = document.getElementById('status');
    const videoFeed = document.getElementById('videoFeed');
    const debugInfo = document.getElementById('debugInfo');
    let isVideoActive = false;
    let connected = false;
    let debugEnabled = false;

    // Debug logging
    function logDebug(message, data = null) {
        const timestamp = new Date().toISOString();
        let logMessage = `${timestamp}: ${message}`;

        if (data) {
            try {
                if (typeof data === 'object') {
                    logMessage += '\n' + JSON.stringify(data, null, 2);
                } else {
                    logMessage += '\n' + data;
                }
            } catch (e) {
                logMessage += '\nError stringifying data: ' + e.message;
            }
        }

        if (debugEnabled) {
            console.log(logMessage);
            debugInfo.innerHTML = logMessage + '\n\n' + debugInfo.innerHTML;
            if (debugInfo.innerHTML.length > 10000) {
                debugInfo.innerHTML = debugInfo.innerHTML.substring(0, 10000) + '...';
            }
        }
    }

    // Toggle debug display
    document.getElementById('toggleDebug').addEventListener('click', function() {
        debugEnabled = !debugEnabled;
        debugInfo.style.display = debugEnabled ? 'block' : 'none';
        this.textContent = debugEnabled ? 'Hide Debug Info' : 'Show Debug Info';
    });

    // Helper function for making API calls
    async function sendCommand(cmd, options = {}) {
        try {
            if (!connected && cmd !== 'connect') {
                status.textContent = 'Status: Not connected to Raspberry Pi';
                return null;
            }

            const url = `${API_URL}/${cmd.startsWith('connect') || cmd.startsWith('disconnect') ? cmd : 'command/' + cmd}`;
            const params = options.angle ? `?angle=${options.angle}` : '';

            console.log(`Sending command: ${cmd} to ${url}${params}`);

            const response = await fetch(url + params, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: options.body ? JSON.stringify(options.body) : null
            });

            // Check if the response was successful
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // Check content type to make sure it's JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                console.warn('Response is not JSON, getting text instead');
                const text = await response.text();
                console.log('Raw response:', text);

                // Try to convert to JSON if it looks like JSON
                const trimmed = text.trim();
                if (trimmed && (trimmed.startsWith('{') || trimmed.startsWith('['))) {
                    try {
                        const data = JSON.parse(trimmed);
                        status.textContent = `Status: ${data.message || 'Command sent'}`;
                        return data;
                    } catch (e) {
                        console.error('Failed to parse JSON from text:', e);
                    }
                }

                // Return a simple object if we can't parse JSON
                return { status: 'unknown', message: text || 'Command sent' };
            }

            // Parse JSON response
            try {
                const data = await response.json();
                status.textContent = `Status: ${data.message || 'Command sent'}`;
                return data;
            } catch (error) {
                console.error('JSON parsing error:', error);
                status.textContent = `Error: Failed to parse response`;
                return null;
            }
        } catch (error) {
            console.error('API error:', error);
            status.textContent = `Error: ${error.message}`;
            return null;
        }
    }

    // Elements
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const macAddressInput = document.getElementById('macAddress');
    const connectionIndicator = document.getElementById('connectionIndicator');
    const controlButtons = document.querySelectorAll('.controls button');
    const scanEnvBtn = document.getElementById('scanEnv');
    const toggleVideoBtn = document.getElementById('toggleVideo');

    // Setup bluetooth connection
    connectBtn.addEventListener('click', async () => {
        const macAddress = macAddressInput.value.trim();

        if (!macAddress) {
            status.textContent = 'Status: Please enter a MAC address';
            return;
        }

        status.textContent = 'Status: Connecting...';
        connectBtn.disabled = true;

        const result = await sendCommand('connect', {
            body: { mac: macAddress }
        });

        if (result && result.status === 'success') {
            connected = true;
            connectionIndicator.classList.remove('disconnected');
            connectionIndicator.classList.add('connected');
            disconnectBtn.disabled = false;
            enableButtons(true);
            status.textContent = `Status: ${result.message}`;
        } else {
            status.textContent = `Status: Connection failed${result ? ': ' + result.message : ''}`;
            connectBtn.disabled = false;
        }
    });

    disconnectBtn.addEventListener('click', async () => {
        status.textContent = 'Status: Disconnecting...';

        const result = await sendCommand('disconnect');

        if (result && result.status === 'success') {
            connected = false;
            connectionIndicator.classList.remove('connected');
            connectionIndicator.classList.add('disconnected');
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            enableButtons(false);

            // Hide video feed if active
            if (isVideoActive) {
                clearInterval(videoInterval);
                videoFeed.style.display = 'none';
                toggleVideoBtn.textContent = 'Start Video Feed';
                isVideoActive = false;
            }

            status.textContent = `Status: ${result.message}`;
        } else {
            status.textContent = 'Status: Disconnection failed';
        }
    });

    function enableButtons(enable) {
        // Enable/disable control buttons
        controlButtons.forEach(button => {
            button.disabled = !enable;
        });

        scanEnvBtn.disabled = !enable;
        toggleVideoBtn.disabled = !enable;
    }

    // Handle button press and release
    function setupButton(id, pressCommand, angle = null) {
        const button = document.getElementById(id);

        // Touch events
        button.addEventListener('touchstart', async (e) => {
            e.preventDefault();
            const options = angle !== null ? { body: { angle: angle } } : {};
            await sendCommand(pressCommand, options);
        });

        button.addEventListener('touchend', async (e) => {
            e.preventDefault();
            await sendCommand('stop');
        });

        // Mouse events
        button.addEventListener('mousedown', async () => {
            const options = angle !== null ? { body: { angle: angle } } : {};
            await sendCommand(pressCommand, options);
        });

        button.addEventListener('mouseup', async () => {
            await sendCommand('stop');
        });

        // Prevent stuck movement if mouse leaves button while pressed
        button.addEventListener('mouseleave', async () => {
            await sendCommand('stop');
        });
    }

    // Setup control buttons
    setupButton('up', 'forward');
    setupButton('down', 'backward');
    setupButton('left', 'left', -30);
    setupButton('right', 'right', 30);

    // Video feed handling
    let videoInterval;
    toggleVideoBtn.addEventListener('click', async function() {
        if (!isVideoActive) {
            // Start video
            const response = await sendCommand('see');

            if (response && response.status === 'success') {
                videoFeed.style.display = 'block';
                this.textContent = 'Stop Video Feed';

                // Start polling for new frames
                videoInterval = setInterval(() => {
                    const timestamp = new Date().getTime();
                    videoFeed.src = `${API_URL}/video_feed?t=${timestamp}`;
                }, 100);

                isVideoActive = true;
            }
        } else {
            // Stop video
            await sendCommand('blind');
            clearInterval(videoInterval);
            videoFeed.style.display = 'none';
            this.textContent = 'Start Video Feed';
            isVideoActive = false;
        }
    });

    // Environment scanning
    scanEnvBtn.addEventListener('click', async function() {
        try {
            // Show loading state
            this.disabled = true;
            status.textContent = 'Status: Scanning environment...';

            // Get the scan data
            const response = await sendCommand('scan');

            if (response && response.status === 'success') {
                // Display the matplotlib visualization
                const mapImg = document.getElementById('mapVisualization');
                mapImg.src = `data:image/png;base64,${response.data.plot_image}`;

                // Display the ASCII map
                const asciiMap = document.getElementById('asciiMap');
                if (response.data.grid_data && response.data.grid_data.grid) {
                    // Create ASCII representation
                    const grid = response.data.grid_data.grid;
                    const position = response.data.world_state.position;

                    // Create ASCII representation based on grid data
                    let asciiRepresentation = '';
                    for (let y = 0; y < grid.length; y++) {
                        let row = '';
                        for (let x = 0; x < grid[y].length; x++) {
                            const cell = grid[y][x];

                            // Add robot position indicator at center
                            const robotX = Math.floor(grid[y].length / 2);
                            const robotY = Math.floor(grid.length / 2);

                            if (x === robotX && y === robotY) {
                                row += 'R';
                            } else if (cell === 1) {
                                row += '#'; // Obstacle
                            } else if (cell === 0) {
                                row += ' '; // Free space
                            } else {
                                row += '.'; // Unknown
                            }
                        }
                        asciiRepresentation += row + '\n';
                    }

                    // Add position info
                    asciiRepresentation += `\nRobot position: (${position.x.toFixed(1)}, ${position.y.toFixed(1)}), ` +
                                         `Heading: ${position.heading.toFixed(1)}°`;

                    asciiMap.textContent = asciiRepresentation;
                }

                status.textContent = 'Status: Scan complete';
            } else {
                status.textContent = `Status: Scan failed${response ? ': ' + response.message : ''}`;
            }
        } catch (error) {
            status.textContent = `Error: ${error.message}`;
            console.error('Scan error:', error);
        } finally {
            this.disabled = false;
        }
    });

    // Check initial connection status on page load
    async function checkConnectionStatus() {
        try {
            const response = await fetch(`${API_URL}/status`);
            const data = await response.json();

            if (data.status === 'success' && data.connected) {
                connected = true;
                connectionIndicator.classList.remove('disconnected');
                connectionIndicator.classList.add('connected');
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                enableButtons(true);
                status.textContent = 'Status: Connected to Raspberry Pi';
            }
        } catch (error) {
            console.error('Error checking connection status:', error);
        }
    }

    // Initialize
    checkConnectionStatus();

    // Cleanup on page unload
    window.addEventListener('beforeunload', async () => {
        if (isVideoActive) {
            clearInterval(videoInterval);
            await sendCommand('blind');
        }
        await sendCommand('stop');
    });
</script>
</body>
</html>