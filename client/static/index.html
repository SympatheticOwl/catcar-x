<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PicarX Controller</title>
    <link rel="stylesheet" type="text/css" href="./stacks.min.css">
    <script>
        (function () {
            var forceSetting = localStorage.getItem("forceDarkModeOn");
            var forceHighContrast = localStorage.getItem("forceHighContrastModeOn");
            var browserPrefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
            var darkModeEnabled = forceSetting === "true" || (!forceSetting && browserPrefersDark);

            if (browserPrefersDark) {
                document.body.classList.toggle("theme-system", darkModeEnabled);
                document.body.classList.toggle("theme-dark", false);
            }
            else {
                document.body.classList.toggle("theme-system", true);
                document.body.classList.toggle("theme-dark", darkModeEnabled);
            }

            var customTheme = localStorage.getItem("customTheme");

            if (customTheme === "true") {
                document.body.classList.add("theme-custom", "themed");
            } else {
                document.body.classList.remove("theme-custom", "themed");
            }

            if (forceHighContrast === "true") {
                document.body.classList.add("theme-highcontrast");
            } else {
                document.body.classList.remove("theme-highcontrast");
            }
        }());

    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 300px;
            margin: 20px auto;
        }

        .controls button {
            padding: 20px;
            font-size: 18px;
            cursor: pointer;
        }

        .button-row {
            text-align: center;
        }

        #up {
            grid-column: 2;
        }

        #left {
            grid-column: 1;
            grid-row: 2;
        }

        #right {
            grid-column: 3;
            grid-row: 2;
        }

        #down {
            grid-column: 2;
            grid-row: 3;
        }

        #videoContainer {
            margin: 20px auto;
            text-align: center;
        }

        #videoFeed {
            max-width: 100%;
            margin-top: 10px;
        }

        #status {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #mapContainer {
            background: var(--theme-background-color);
            border: 1px solid var(--theme-border-color);
            border-radius: 4px;
            padding: 15px;
            margin: 20px auto;
            max-width: 600px;
        }

        #mapVisualization {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        #asciiMap {
            margin-top: 15px;
            padding: 10px;
            background: var(--theme-code-background-color);
            border-radius: 4px;
            white-space: pre;
        }
    </style>
</head>
<body>
<h1>PicarX Controller</h1>

<div id="status">Status: Ready</div>

<div class="controls">
    <button id="up">↑</button>
    <button id="left">←</button>
    <button id="right">→</button>
    <button id="down">↓</button>
</div>

<div class="button-row">
    <button id="scanEnv">Scan Environment</button>
</div>

<div class="button-row">
    <button id="toggleVideo">Start Video Feed</button>
</div>

<div id="videoContainer">
    <img id="videoFeed" style="display: none;">
</div>
<div id="mapContainer" style="margin: 20px auto; text-align: center;">
    <h2>Environment Map</h2>
    <img id="mapVisualization" style="max-width: 100%; margin-top: 10px;">
    <pre id="asciiMap" style="text-align: left; font-family: monospace; overflow-x: auto;"></pre>
</div>

<script>
    const API_URL = 'http://10.0.0.219:8000';  // Replace with your Pi's IP
    const status = document.getElementById('status');
    const videoFeed = document.getElementById('videoFeed');
    let isVideoActive = false;

    // Helper function for making API calls
    async function sendCommand(cmd, options = {}) {
        try {
            // const queryString = options.angle ? `?angle=${options.angle}` : '';
            const response = await fetch(`${API_URL}/command/${cmd}`, {
                method: 'POST'
            });
            const data = await response.json();
            status.textContent = `Status: ${data.message}`;
            return data;
        } catch (error) {
            status.textContent = `Error: ${error.message}`;
            throw error;
        }
    }

    // Handle button press and release
    function setupButton(id, pressCommand, angle = null) {
        const button = document.getElementById(id);

        // Touch events
        button.addEventListener('touchstart', async (e) => {
            e.preventDefault();
            await sendCommand(pressCommand, { angle });
        });

        button.addEventListener('touchend', async (e) => {
            e.preventDefault();
            await sendCommand('stop');
        });

        // Mouse events
        button.addEventListener('mousedown', async () => {
            await sendCommand(pressCommand, { angle });
        });

        button.addEventListener('mouseup', async () => {
            await sendCommand('stop');
        });

        // Prevent stuck movement if mouse leaves button while pressed
        button.addEventListener('mouseleave', async () => {
            await sendCommand('stop');
        });
    }

    // Setup control buttons
    setupButton('up', 'forward');
    setupButton('down', 'backward');
    setupButton('left', 'left', -30);
    setupButton('right', 'right', 30);

    // Video feed handling
    let videoInterval;
    document.getElementById('toggleVideo').addEventListener('click', async function() {
        if (!isVideoActive) {
            // Start video
            await sendCommand('see');
            videoFeed.style.display = 'block';
            this.textContent = 'Stop Video Feed';

            // Start polling for new frames
            videoInterval = setInterval(async () => {
                const timestamp = new Date().getTime();
                videoFeed.src = `${API_URL}/video_feed?t=${timestamp}`;
            }, 100);

            isVideoActive = true;
        } else {
            // Stop video
            clearInterval(videoInterval);
            videoFeed.style.display = 'none';
            this.textContent = 'Start Video Feed';
            isVideoActive = false;
        }
    });

    document.getElementById('scanEnv').addEventListener('click', async function() {
        let test = await sendCommand('scan');
        console.log(test)
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', async () => {
        if (isVideoActive) {
            clearInterval(videoInterval);
        }
        await sendCommand('stop');
    });

    document.getElementById('scanEnv').addEventListener('click', async function() {
        try {
            // Show loading state
            this.disabled = true;
            status.textContent = 'Status: Scanning environment...';

            // Get the visualization data
            const response = await fetch(`${API_URL}/visualization`);
            const data = await response.json();

            if (data.status === 'success') {
                // Display the matplotlib visualization
                const mapImg = document.getElementById('mapVisualization');
                mapImg.src = `data:image/png;base64,${data.data.plot_image}`;

                // Display the ASCII map
                const asciiMap = document.getElementById('asciiMap');
                if (data.data.grid_data && data.data.grid_data.grid) {
                    // Create ASCII representation
                    const grid = data.data.grid_data.grid;
                    const asciiRepresentation = grid.map(row =>
                        row.map(cell => cell === 2 ? 'C' : cell === 1 ? '#' : '.').join('')
                    ).join('\n');
                    asciiMap.textContent = asciiRepresentation;
                }

                status.textContent = 'Status: Scan complete';
            } else {
                status.textContent = `Status: Error - ${data.message}`;
            }
        } catch (error) {
            status.textContent = `Error: ${error.message}`;
        } finally {
            this.disabled = false;
        }
    });
</script>
</body>
</html>