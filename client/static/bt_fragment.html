<h1>PicarX Bluetooth Controller</h1>

<div class="connection-panel">
    <h2>Connection</h2>
    <div id="connectionStatus" class="disconnected">Status: Disconnected</div>
    <div class="button-row">
        <input type="text" id="btAddress" , value="D8:3A:DD:6D:E3:54"
               placeholder="Raspberry Pi Bluetooth address (e.g., 00:11:22:33:44:55)">
        <button id="connectButton">Connect</button>
        <button id="disconnectButton" disabled>Disconnect</button>
    </div>
</div>

<div id="status">Status: Ready</div>

<div class="controls">
    <button id="up" disabled>↑</button>
    <button id="left" disabled>←</button>
    <button id="right" disabled>→</button>
    <button id="down" disabled>↓</button>
</div>
<!-- Add this right after the controls div or before the telemetry card -->
<div class="speed-control-container s-card bs-md m-2">
    <div class="s-card--header bg-secondary-025 fw-bold">
        Speed Control
    </div>
    <div class="s-card--content">
        <div class="d-flex fd-column g8">
            <div class="d-flex ai-center g8">
                <label for="speedControl" class="flex--item" style="width: 80px;">Speed:</label>
                <input type="range" id="speedControl" min="0.1" max="1.0" step="0.05" value="0.5" disabled class="flex--item" style="flex: 1;">
                <div class="flex--item" style="width: 40px; text-align: right;">
                    <span id="speedValue">0.50</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add this CSS to the head or existing style tag -->
<style>
    .speed-control-container {
        margin-bottom: 1rem;
    }

    #speedControl {
        width: 100%;
        height: 20px;
    }

    /* Custom styling for the range input */
    input[type=range] {
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        cursor: pointer;
    }

    /* Track styles */
    input[type=range]::-webkit-slider-runnable-track {
        background: #ddd;
        height: 8px;
        border-radius: 4px;
    }

    input[type=range]::-moz-range-track {
        background: #ddd;
        height: 8px;
        border-radius: 4px;
    }

    /* Thumb styles */
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        margin-top: -4px; /* Thumb position adjustment */
        background-color: #4a90e2;
        height: 16px;
        width: 16px;
        border-radius: 50%;
    }

    input[type=range]::-moz-range-thumb {
        border: none;
        background-color: #4a90e2;
        height: 16px;
        width: 16px;
        border-radius: 50%;
    }

    /* Focus styles */
    input[type=range]:focus {
        outline: none;
    }

    input[type=range]:focus::-webkit-slider-thumb {
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3);
    }

    input[type=range]:focus::-moz-range-thumb {
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.3);
    }

    /* Disabled styles */
    input[type=range]:disabled::-webkit-slider-runnable-track {
        background: #eee;
    }

    input[type=range]:disabled::-moz-range-track {
        background: #eee;
    }

    input[type=range]:disabled::-webkit-slider-thumb {
        background-color: #ccc;
    }

    input[type=range]:disabled::-moz-range-thumb {
        background-color: #ccc;
    }
</style>
<div class="s-card bs-md m-2">
    <div class="s-card--header bg-secondary-025 fw-bold">
        PicarX Telemetry
    </div>
    <div class="s-card--content" id="telemetry-data">
        <div class="d-flex fd-column g8">
            <!-- CPU Temperature Section -->
            <div>
                <h5 class="mb-2">CPU Temperature</h5>
                <div class="d-flex ai-center g8">
                    <div class="flex--item">
                        <span id="cpu-temp">--</span>°C
                    </div>
                    <div class="flex--item">
                        <div class="d-flex ai-center" id="cpu-temp-bar">
                            <div class="s-progress s-progress__danger" style="width: 100px;">
                                <div class="s-progress--bar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Battery Section -->
            <div>
                <h5 class="mb-2">Battery</h5>
                <div class="d-flex fd-column g4">
                    <div class="d-flex ai-center g8">
                        <div class="flex--item" style="width: 80px;">Level:</div>
                        <div class="flex--item">
                            <span id="battery-level">--</span>%
                        </div>
                        <div class="flex--item">
                            <div class="d-flex ai-center" id="battery-level-bar">
                                <div class="s-progress" style="width: 100px;">
                                    <div class="s-progress--bar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex ai-center">
                        <div class="flex--item" style="width: 80px;">Voltage:</div>
                        <div class="flex--item">
                            <span id="battery-voltage">--</span>V
                        </div>
                    </div>
                    <div class="d-flex ai-center">
                        <div class="flex--item" style="width: 80px;">Status:</div>
                        <div class="flex--item">
                            <span id="battery-status">Unknown</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Load Section -->
            <div>
                <h5 class="mb-2">System</h5>
                <div class="d-flex fd-column g4">
                    <div class="d-flex ai-center g8">
                        <div class="flex--item" style="width: 80px;">CPU:</div>
                        <div class="flex--item">
                            <span id="cpu-usage">--</span>%
                        </div>
                        <div class="flex--item">
                            <div class="d-flex ai-center" id="cpu-usage-bar">
                                <div class="s-progress" style="width: 100px;">
                                    <div class="s-progress--bar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex ai-center g8">
                        <div class="flex--item" style="width: 80px;">Memory:</div>
                        <div class="flex--item">
                            <span id="memory-usage">--</span>%
                        </div>
                        <div class="flex--item">
                            <div class="d-flex ai-center" id="memory-usage-bar">
                                <div class="s-progress" style="width: 100px;">
                                    <div class="s-progress--bar" style="width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex ai-center">
                        <div class="flex--item" style="width: 80px;">Load:</div>
                        <div class="flex--item">
                            <span id="load-average">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Last Updated -->
            <div class="mt-2 fs-caption fc-light">
                Last updated: <span id="telemetry-timestamp">--</span>
                <button class="s-btn s-btn__xs ml-2" id="refresh-telemetry">
                    Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Use the local client bridge server URL
    const API_URL = window.location.origin; // e.g., http://localhost:8080
    const status = document.getElementById('status');
    const btAddress = document.getElementById('btAddress');
    const connectButton = document.getElementById('connectButton');
    const disconnectButton = document.getElementById('disconnectButton');
    const connectionStatus = document.getElementById('connectionStatus');

    let isConnected = false;

    // Connect to the Raspberry Pi via Bluetooth
    connectButton.addEventListener('click', async function () {
        const address = btAddress.value.trim();
        if (!address) {
            status.textContent = 'Status: Please enter a Bluetooth address';
            return;
        }

        try {
            status.textContent = 'Status: Connecting...';
            const response = await fetch(`${API_URL}/connect`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({bt_address: address})
            });

            const data = await response.json();

            if (data.status === 'success') {
                isConnected = true;
                connectionStatus.textContent = 'Status: Connected';
                connectionStatus.className = 'connected';
                status.textContent = `Status: ${data.message}`;

                // Enable control buttons
                document.querySelectorAll('.controls button').forEach(button => {
                    button.disabled = false;
                });

                connectButton.disabled = true;
                disconnectButton.disabled = false;

                // Save address for future use
                localStorage.setItem('picarx_bt_address', address);
            } else {
                status.textContent = `Status: ${data.message}`;
            }
        } catch (error) {
            status.textContent = `Error: ${error.message}`;
        }
    });

    // Disconnect from the Raspberry Pi
    disconnectButton.addEventListener('click', async function () {
        try {
            const response = await fetch(`${API_URL}/disconnect`, {
                method: 'POST'
            });

            const data = await response.json();

            isConnected = false;
            connectionStatus.textContent = 'Status: Disconnected';
            connectionStatus.className = 'disconnected';
            status.textContent = `Status: ${data.message}`;

            // Disable control buttons
            document.querySelectorAll('.controls button').forEach(button => {
                button.disabled = true;
            });

            connectButton.disabled = false;
            disconnectButton.disabled = true;
        } catch (error) {
            status.textContent = `Error: ${error.message}`;
        }
    });

    // Helper function for making API calls with timeout
    async function sendCommand(cmd, options = {}) {
        if (!isConnected) {
            status.textContent = 'Status: Not connected to Raspberry Pi';
            return;
        }

        try {
            const queryString = options.angle ? `?angle=${options.angle}` : '';
            console.log(`Sending command: ${cmd}${queryString}`);

            // Use AbortController for timeout control
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), options.timeout || 60000); // Default 60s timeout

            const response = await fetch(`${API_URL}/command/${cmd}${queryString}`, {
                method: 'POST',
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            const data = await response.json();
            status.textContent = `Status: ${data.message || data.status}`;
            return data;
        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('Request timed out');
                status.textContent = `Error: Request timed out. The server may still be processing the command.`;
            } else {
                status.textContent = `Error: ${error.message}`;
            }
            throw error;
        }
    }

    // Handle button press and release
    function setupButton(id, pressCommand, angle = null) {
        const button = document.getElementById(id);
        let isPressed = false;

        // Touch events
        button.addEventListener('touchstart', async (e) => {
            e.preventDefault();
            if (!isPressed) {
                isPressed = true;
                button.classList.add('active');
                await sendCommand(pressCommand, {angle});
            }
        });

        button.addEventListener('touchend', async (e) => {
            e.preventDefault();
            if (isPressed) {
                isPressed = false;
                button.classList.remove('active');
                await sendCommand('stop');
            }
        });

        // Mouse events
        button.addEventListener('mousedown', async () => {
            if (!isPressed) {
                isPressed = true;
                button.classList.add('active');
                await sendCommand(pressCommand, {angle});
            }
        });

        button.addEventListener('mouseup', async () => {
            if (isPressed) {
                isPressed = false;
                button.classList.remove('active');
                await sendCommand('stop');
            }
        });

        // Prevent stuck movement if mouse leaves button while pressed
        button.addEventListener('mouseleave', async () => {
            if (isPressed) {
                isPressed = false;
                button.classList.remove('active');
                await sendCommand('stop');
            }
        });
    }

    // Setup control buttons
    setupButton('up', 'forward');
    setupButton('down', 'backward');
    setupButton('left', 'left', -30);
    setupButton('right', 'right', 30);

    // Keyboard controls
    document.addEventListener('keydown', async function (event) {
        if (!isConnected) return;

        switch (event.key) {
            case 'ArrowUp':
                event.preventDefault();
                document.getElementById('up').classList.add('active');
                await sendCommand('forward');
                break;
            case 'ArrowDown':
                event.preventDefault();
                document.getElementById('down').classList.add('active');
                await sendCommand('backward');
                break;
            case 'ArrowLeft':
                event.preventDefault();
                document.getElementById('left').classList.add('active');
                await sendCommand('left', {angle: -30});
                break;
            case 'ArrowRight':
                event.preventDefault();
                document.getElementById('right').classList.add('active');
                await sendCommand('right', {angle: 30});
                break;
        }
    });

    document.addEventListener('keyup', async function (event) {
        if (!isConnected) return;

        switch (event.key) {
            case 'ArrowUp':
            case 'ArrowDown':
            case 'ArrowLeft':
            case 'ArrowRight':
                event.preventDefault();
                document.querySelectorAll('.controls button').forEach(btn => {
                    btn.classList.remove('active');
                });
                await sendCommand('stop');
                break;
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', async () => {
        if (isConnected) {
            try {
                // Stop any movement
                await sendCommand('stop');

                // Disconnect
                await fetch(`${API_URL}/disconnect`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('Error during cleanup:', error);
            }
        }
    });

    // Add some CSS to show active button states
    document.head.insertAdjacentHTML('beforeend', `
    <style>
        .controls button.active {
            background-color: #2a70c2;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
            transform: scale(0.95);
        }

        /* Spinner for scan progress */
        .spinner {
            display: inline-block;
            width: 15px;
            height: 15px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top-color: #4a90e2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    `);

    // Add periodic status check for connection monitoring
    function checkStatus() {
        if (isConnected) {
            // Use AbortController to prevent hanging status checks
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout for status checks

            fetch(`${API_URL}/status`, {
                signal: controller.signal
            })
                .then(response => response.json())
                .then(data => {
                    // Reset fail count on successful response
                    statusFailCount = 0;

                    // Update status indicators if needed based on response
                    if (data.emergency_stop) {
                        status.textContent = 'Status: Emergency stop active';
                        status.style.borderLeftColor = '#dc3545';
                    } else {
                        status.style.borderLeftColor = '#4a90e2';
                    }
                })
                .catch(error => {
                    // // Don't count abort errors (timeouts) as connection failures
                    // // during scan operations - the server might just be busy
                    // if (error.name === 'AbortError' && scanProgress.style.display === 'inline-block') {
                    //     console.log('Status check timed out during scanning operation - ignoring');
                    //     return;
                    // }

                    console.error('Status check failed:', error);
                    // If status check fails multiple times, consider disconnected
                    if (isConnected) {
                        statusFailCount++;
                        console.log(`Status check failure count: ${statusFailCount}/3`);

                        if (statusFailCount > 3) {
                            connectionStatus.textContent = 'Status: Connection lost';
                            connectionStatus.className = 'disconnected';
                            isConnected = false;

                            // Disable control buttons
                            document.querySelectorAll('.controls button').forEach(button => {
                                button.disabled = true;
                            });

                            connectButton.disabled = false;
                            disconnectButton.disabled = true;
                        }
                    }
                })
                .finally(() => {
                    clearTimeout(timeoutId);
                });
        }
    }

    let statusFailCount = 0;
    // Check status every 5 seconds
    setInterval(checkStatus, 5000);
</script>